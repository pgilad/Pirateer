app.service("searchService",["$http","$q",function(a,b){var c={getTitleURI:"http://www.imdb.com/xml/find?json=1&nr=1&tt=on&mx=1&q=",getRatingURI:"http://p.media-imdb.com/static-content/documents/v1/title/AAA/ratings%3Fjsonp=imdb.rating.run:imdb.api.title.ratings/data.json"},d=[],e=[],f={},g=["title_popular","title_substring","title_exact"],h=function(h){d=[],e=[];var j=b.defer(),k=h.title,l=h.year;return l=parseInt(l)||null,a.get(c.getTitleURI+encodeURI(k)).success(function(a){var b,c=0,d=0;for(angular.forEach(g,function(a){f[a]=[]}),d=0;d<g.length;++d){var e=g[d];for(c=0;a[e]&&c<a[e].length&&3>c;++c)b=parseInt(a[e][c].description.substring(0,4)),angular.isNumber(l)&&angular.isNumber(b)&&Math.abs(l-b)>1||f[e].push({id:a[e][c].id,title:a[e][c].title})}var k=f.title_popular&&f.title_popular[0];k||(k=f.title_substring&&f.title_substring[0]),k||(k=f.title_exact&&f.title_exact[0]),k?(angular.extend(k,{indexArr:h.indexArr}),i(k,j)):j.reject()}).error(function(){j.reject()}),j.promise},i=function(b,d){var e=c.getRatingURI.replace("AAA",b.id);a.get(e).success(function(a){var c=a.substring("imdb.rating.run(".length);c=JSON.parse(c.substring(0,c.length-1)),c.resource&&(b.rating=c.resource.rating,b.year=c.resource.year,b.titleType=c.resource.titleType,b.ratingCount=c.resource.ratingCount,b.topRank=c.resource.topRank),d.resolve(b)}).error(function(){d.reject()})};return{searchIMDB:h,getRating:i}}]);